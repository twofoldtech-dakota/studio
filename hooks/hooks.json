{
  "description": "STUDIO Orchestration Hook System - Wires orchestration to commands and agents",
  "version": "5.0.0",

  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "Before spawning a subagent, check if orchestration is active (.studio/orchestration/.current exists). If active and the subagent is planner or builder: 1) Run scripts/skills.sh detect \"$GOAL\" to find matching skills. 2) For each detected skill, run scripts/skills.sh inject <skill> to get injection content. 3) Prepend this skill context to the agent's prompt so it receives domain-specific guidance."
          }
        ]
      }
    ],

    "PreCommand": [
      {
        "matcher": "build",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "ORCHESTRATION TRIGGER: A /build command was invoked.\n\n1. INITIALIZE orchestration session:\n   - Run: scripts/orchestrator.sh init \"$ARGUMENTS\" implicit\n   - This creates .studio/orchestration/<session_id>/state.json\n\n2. ROUTE the goal:\n   - Run: scripts/orchestrator.sh route\n   - Check routing.selected_workflow in the output\n\n3. IF workflow is 'plan_then_build':\n   - First invoke the Planner agent with the goal\n   - After Planner completes, record handoff: scripts/orchestrator.sh handoff planner builder '{\"task_id\": \"<task_id>\", \"plan_path\": \"<plan_path>\"}'\n   - Then proceed with Builder\n\n4. IF workflow is 'build_only':\n   - Proceed directly to Builder execution\n\n5. Before starting each agent:\n   - Run: scripts/orchestrator.sh agent-start <agent_name>\n\n6. After each agent completes:\n   - Run: scripts/orchestrator.sh agent-complete <agent_name>\n   - Run: scripts/orchestrator.sh checkpoint '<agent_name>_complete'\n\nThe orchestration state is persisted in .studio/orchestration/ for recovery."
          },
          {
            "type": "prompt",
            "prompt": "KNOWLEDGE BASE INJECTION:\n\nBefore starting the build, inject Strict Constraints as a \"NEVER VIOLATE\" list:\n\n1. READ STUDIO_KNOWLEDGE_BASE.md\n2. EXTRACT the Strict Constraints section\n3. IF there are entries:\n   - Present them as: \"STRICT CONSTRAINTS (NEVER VIOLATE):\"\n   - List each SC-XXX entry with its \"What\" and \"Instead\" fields\n4. EXTRACT relevant Slop Ledger entries based on detected domains:\n   - Run: scripts/learnings.sh detect \"$GOAL\"\n   - For each detected domain, include matching slop entries\n5. Present slop entries as: \"AVOID THESE MISTAKES:\"\n   - List each SL-XXX entry with its \"Pattern\" and \"Fix\" fields\n\nThis ensures the build agent is aware of known constraints before writing code."
          }
        ]
      }
    ],

    "SessionStart": [
      {
        "matcher": "startup",
        "hooks": [
          {
            "type": "command",
            "command": "mkdir -p .studio/tasks .studio/orchestration .studio/.cache/summaries 2>/dev/null || true"
          },
          {
            "type": "prompt",
            "prompt": "STUDIO INITIALIZATION:\n\n1. ENSURE directories exist:\n   - mkdir -p .studio/orchestration\n   - mkdir -p .studio/tasks\n   - mkdir -p .studio/.cache/summaries\n\n2. LOAD learnings from studio/learnings/*.md files.\n   Report: 'STUDIO ready. Loaded [N] learnings from [domains].'\n\n3. CHECK for tasks with IN_PROGRESS status in .studio/tasks/ and notify user if found.\n\n4. CHECK context budget status using scripts/context-manager.sh status.\n   If any pool is at WARNING (80%+) or CRITICAL (95%+) level, notify:\n   'Context pressure detected in [pool]. Consider running context optimization.'"
          },
          {
            "type": "prompt",
            "prompt": "ORCHESTRATION RESUME CHECK:\n\n1. Check if .studio/orchestration/.current exists\n2. If it does, read the session ID and load .studio/orchestration/<session_id>/state.json\n3. Check the 'status' field:\n   - If 'paused': Notify user 'Paused orchestration found: [session_id]. Goal: [goal]. Resume with /orchestrate resume or start fresh?'\n   - If 'recovering': Notify user 'Orchestration in recovery: [session_id]. Last failure: [error]. Resume recovery or abort?'\n   - If 'executing': Notify user 'Interrupted orchestration detected: [session_id]. Would you like to resume from the last checkpoint?'\n4. If user wants to resume, run: scripts/orchestrator.sh resume"
          },
          {
            "type": "prompt",
            "prompt": "KNOWLEDGE BASE LOADING:\n\n1. READ STUDIO_KNOWLEDGE_BASE.md if it exists\n2. COUNT entries in each section:\n   - Strict Constraints: [N]\n   - Slop Ledger: [N]\n   - Performance Delta: [N]\n   - Pending Queue: [N]\n3. REPORT: 'Knowledge base loaded: [total] entries ([constraints] constraints, [slop] slop, [perf] performance deltas)'\n4. IF Strict Constraints exist, summarize the top 3 most important rules\n5. CHECK sprint counter status:\n   - Read .studio/sprint-counter.json\n   - Report: 'Sprint [N]: [tasks]/5 tasks until evolution'\n   - If evolution is due (5+ tasks), notify: 'Sprint evolution due - consider running scripts/sprint-evolution.sh propose'"
          }
        ]
      }
    ],

    "SubagentStop": [
      {
        "matcher": "planner|builder|architect",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "AGENT COMPLETION PROTOCOL:\n\n1. CHECK if orchestration is active (.studio/orchestration/.current exists)\n\n2. IF orchestration active:\n   a) Run: scripts/orchestrator.sh agent-complete [agent_name]\n   b) Run: scripts/orchestrator.sh checkpoint '[agent_name]_complete'\n   c) This auto-saves state for recovery\n\n3. IF this was the Planner:\n   - Prepare handoff context with task_id, plan_path, detected skills\n   - Run: scripts/orchestrator.sh handoff planner builder '{\"task_id\": \"...\", \"plan_path\": \"...\", \"skills\": [...]}'\n\n4. IF this was the Builder (and agent_name matches):\n   - Continue to learning capture phase"
          }
        ]
      },
      {
        "matcher": "builder",
        "hooks": [
          {
            "type": "agent",
            "prompt": "SELF-LEARNING PROTOCOL: Capture learnings from this build cycle.\n\nREAD studio/prompts/self-learning.md for the full protocol.\nREAD STUDIO_KNOWLEDGE_BASE.md for existing patterns to avoid duplicates.\n\n1. GENERATE task_id: task_YYYYMMDD_brief_description (e.g., task_20240215_auth_fix)\n\n2. DETECT domain automatically:\n   - Run: git diff --name-only HEAD~1 (or check changed files in this session)\n   - Map file patterns to domains:\n     - **/components/**, *.tsx, *.css → frontend\n     - **/api/**, **/services/** → backend\n     - **/*test*, **/__tests__/** → testing\n     - **/auth/**, **/security/** → security\n     - Performance improvements with metrics → performance\n     - Otherwise → global\n\n3. CLASSIFY the learning using scripts/signal-audit.sh:\n   - Run: scripts/signal-audit.sh classify \"<summary of what happened>\"\n   - Check output for: signal_type, destination, suggested_severity\n\n4. CHECK for duplicates:\n   - Run: scripts/learnings.sh check-duplicate \"<learning title>\" (if command exists)\n   - Or manually scan STUDIO_KNOWLEDGE_BASE.md for similar entries\n\n5. EXTRACT mandatory fields:\n   - task_id: [generated above]\n   - domain: [detected domain]\n   - impact_type: constraint | slop | performance | pattern\n   - severity: HIGH | MEDIUM | LOW\n   - measurable_outcome: [before/after metrics if applicable]\n\n6. SAVE to appropriate destination based on signal_type:\n   - performance → Add to Performance Delta section in STUDIO_KNOWLEDGE_BASE.md (MUST have numbers)\n   - error (1st occurrence) → Add to Pending Queue in STUDIO_KNOWLEDGE_BASE.md\n   - error (2+ occurrences) → Promote to Strict Constraints\n   - convention → Add to Slop Ledger in STUDIO_KNOWLEDGE_BASE.md\n   - pattern → Save to studio/learnings/{domain}.md\n\n7. INCREMENT sprint counter:\n   - Run: scripts/sprint-evolution.sh increment <task_id>\n   - If output is 'EVOLUTION_DUE', notify user to run evolution proposals\n\n8. CONFIRM with user:\n   - Show: task_id, domain, impact_type, severity, destination\n   - Ask for approval before saving\n\n9. UPDATE Definition of Done checklist:\n   - [ ] Learning extracted and classified\n   - [ ] Knowledge base checked for duplicates\n   - [ ] Sprint counter incremented\n\nReturn {\"ok\": true, \"task_id\": \"...\", \"learnings_saved_to\": \"...\", \"sprint_status\": \"...\"} when complete.",
            "timeout": 180
          }
        ]
      }
    ],

    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "Check if there is an active build task with status BUILDING that has not passed quality gates. If found, warn the user: 'Build in progress without quality gate verification. Are you sure you want to stop?' and ask for confirmation before allowing stop."
          },
          {
            "type": "prompt",
            "prompt": "Check for active orchestration session in .studio/orchestration/.current. If found, save a checkpoint using scripts/orchestrator.sh checkpoint 'session_interrupted' before stopping. Report: 'Orchestration checkpoint saved. Resume with /orchestrate resume.'"
          }
        ]
      }
    ],

    "SubagentStart": [
      {
        "matcher": "planner|builder|architect",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "AGENT STARTUP PROTOCOL:\n\n1. CHECK if orchestration is active (.studio/orchestration/.current exists)\n\n2. IF orchestration active:\n   a) Run: scripts/orchestrator.sh agent-start [agent_name]\n   b) Check for incoming handoff: scripts/orchestrator.sh get-handoff [agent_name]\n      - If handoff exists, include the context_passed data in agent context\n      - This contains task_id, plan_path, learnings, and other workflow context\n\n3. DETECT relevant skills for this agent's work:\n   a) Get the current goal from orchestration state or user input\n   b) Run: scripts/skills.sh detect \"$GOAL\"\n   c) For each detected skill (sorted by score):\n      - Run: scripts/skills.sh inject <skill_name>\n      - Include the injection content (questions, guidelines, checklist) in agent context\n\n4. SKILL INJECTION FORMAT:\n   If skills detected, prepend to agent context:\n   ---\n   ## Active Skills: [skill1, skill2]\n   \n   [Injection content from each skill]\n   ---\n\nThis ensures agents receive domain-specific guidance before execution."
          },
          {
            "type": "prompt",
            "prompt": "KNOWLEDGE BASE INJECTION FOR AGENTS:\n\n1. READ STUDIO_KNOWLEDGE_BASE.md\n\n2. EXTRACT and inject Strict Constraints:\n   - Format as: \"## STRICT CONSTRAINTS (NEVER VIOLATE)\"\n   - List each constraint with its \"What\" and \"Instead\" fields\n   - These are BLOCKING rules - agent must not proceed if it would violate\n\n3. DETECT domains relevant to the agent's goal:\n   - Run: scripts/learnings.sh detect \"$GOAL\"\n\n4. EXTRACT relevant Slop Ledger entries for detected domains:\n   - Format as: \"## AVOID THESE MISTAKES\"\n   - List each slop entry with its \"Pattern\" and \"Fix\" fields\n\n5. INJECT into agent context BEFORE the main task prompt:\n   ---\n   ## STRICT CONSTRAINTS (NEVER VIOLATE)\n   [constraints]\n   \n   ## AVOID THESE MISTAKES\n   [relevant slop entries]\n   ---\n\nThis ensures agents are aware of known pitfalls before execution."
          }
        ]
      }
    ],

    "ContextPressure": [
      {
        "matcher": "warning|critical",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "Context pressure detected at {level} level. Run scripts/context-manager.sh scan to identify optimization opportunities. For learnings pool: consider summarizing entries older than 30 days. For plans pool: consider removing completed task plans. For context7 pool: clear cached docs for unused libraries."
          }
        ]
      }
    ]
  }
}
