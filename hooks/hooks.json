{
  "description": "STUDIO Orchestration Hook System - Wires orchestration to commands and agents",
  "version": "4.0.0",

  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "Before spawning a subagent, check if orchestration is active (.studio/orchestration/.current exists). If active and the subagent is planner or builder: 1) Run scripts/skills.sh detect \"$GOAL\" to find matching skills. 2) For each detected skill, run scripts/skills.sh inject <skill> to get injection content. 3) Prepend this skill context to the agent's prompt so it receives domain-specific guidance."
          }
        ]
      }
    ],

    "PreCommand": [
      {
        "matcher": "build",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "ORCHESTRATION TRIGGER: A /build command was invoked.\n\n1. INITIALIZE orchestration session:\n   - Run: scripts/orchestrator.sh init \"$ARGUMENTS\" implicit\n   - This creates .studio/orchestration/<session_id>/state.json\n\n2. ROUTE the goal:\n   - Run: scripts/orchestrator.sh route\n   - Check routing.selected_workflow in the output\n\n3. IF workflow is 'plan_then_build':\n   - First invoke the Planner agent with the goal\n   - After Planner completes, record handoff: scripts/orchestrator.sh handoff planner builder '{\"task_id\": \"<task_id>\", \"plan_path\": \"<plan_path>\"}'\n   - Then proceed with Builder\n\n4. IF workflow is 'build_only':\n   - Proceed directly to Builder execution\n\n5. Before starting each agent:\n   - Run: scripts/orchestrator.sh agent-start <agent_name>\n\n6. After each agent completes:\n   - Run: scripts/orchestrator.sh agent-complete <agent_name>\n   - Run: scripts/orchestrator.sh checkpoint '<agent_name>_complete'\n\nThe orchestration state is persisted in .studio/orchestration/ for recovery."
          }
        ]
      }
    ],

    "SessionStart": [
      {
        "matcher": "startup",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "STUDIO INITIALIZATION:\n\n1. ENSURE directories exist:\n   - mkdir -p .studio/orchestration\n   - mkdir -p .studio/tasks\n   - mkdir -p .studio/.cache/summaries\n\n2. LOAD learnings from studio/learnings/*.md files.\n   Report: 'STUDIO ready. Loaded [N] learnings from [domains].'\n\n3. CHECK for tasks with IN_PROGRESS status in .studio/tasks/ and notify user if found.\n\n4. CHECK context budget status using scripts/context-manager.sh status.\n   If any pool is at WARNING (80%+) or CRITICAL (95%+) level, notify:\n   'Context pressure detected in [pool]. Consider running context optimization.'"
          },
          {
            "type": "prompt",
            "prompt": "ORCHESTRATION RESUME CHECK:\n\n1. Check if .studio/orchestration/.current exists\n2. If it does, read the session ID and load .studio/orchestration/<session_id>/state.json\n3. Check the 'status' field:\n   - If 'paused': Notify user 'Paused orchestration found: [session_id]. Goal: [goal]. Resume with /orchestrate resume or start fresh?'\n   - If 'recovering': Notify user 'Orchestration in recovery: [session_id]. Last failure: [error]. Resume recovery or abort?'\n   - If 'executing': Notify user 'Interrupted orchestration detected: [session_id]. Would you like to resume from the last checkpoint?'\n4. If user wants to resume, run: scripts/orchestrator.sh resume"
          }
        ]
      }
    ],

    "SubagentStop": [
      {
        "matcher": "planner|builder|architect",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "AGENT COMPLETION PROTOCOL:\n\n1. CHECK if orchestration is active (.studio/orchestration/.current exists)\n\n2. IF orchestration active:\n   a) Run: scripts/orchestrator.sh agent-complete [agent_name]\n   b) Run: scripts/orchestrator.sh checkpoint '[agent_name]_complete'\n   c) This auto-saves state for recovery\n\n3. IF this was the Planner:\n   - Prepare handoff context with task_id, plan_path, detected skills\n   - Run: scripts/orchestrator.sh handoff planner builder '{\"task_id\": \"...\", \"plan_path\": \"...\", \"skills\": [...]}'\n\n4. IF this was the Builder (and agent_name matches):\n   - Continue to learning capture phase"
          }
        ]
      },
      {
        "matcher": "builder",
        "hooks": [
          {
            "type": "agent",
            "prompt": "LEARN PHASE: Capture learnings from this build cycle.\n\n1. DETECT domain automatically:\n   - Run: git diff --name-only HEAD~1 (or check changed files in this session)\n   - Map file patterns to domains:\n     - **/components/**, *.tsx, *.css → frontend\n     - **/api/**, **/services/** → backend\n     - **/*test*, **/__tests__/** → testing\n     - **/auth/**, **/security/** → security\n     - Otherwise → global\n\n2. SUMMARIZE what worked well during this build:\n   - Patterns that were effective\n   - Approaches that succeeded on first try\n   - Code that was clean and maintainable\n\n3. LIST any problems encountered and their solutions:\n   - Errors that required fixes\n   - Unexpected issues and how they were resolved\n   - Retry attempts and what finally worked\n\n4. NOTE any new patterns discovered:\n   - Novel approaches used\n   - Reusable code structures\n   - Integration techniques\n\n5. CONFIRM with user:\n   Detected domain: [detected_domain]\n   Save learning here? Or choose:\n   - global (project-wide)\n   - frontend (UI/components)\n   - backend (API/services)\n   - testing (test strategies)\n   - security (security patterns)\n   - performance (optimizations)\n   - integration:<name> (library-specific)\n\n6. WRITE the learning to studio/learnings/{domain}.md using this format:\n   ## YYYY-MM-DD: Brief Title\n   \n   **Context:** Task description\n   \n   **What Worked:**\n   - Item 1\n   - Item 2\n   \n   **Problems Solved:**\n   - Problem: Description\n     Solution: How it was fixed\n   \n   **Pattern:**\n   ```\n   code example if applicable\n   ```\n\nReturn {\"ok\": true, \"learnings_saved_to\": \"domain.md\"} when complete.",
            "timeout": 120
          }
        ]
      }
    ],

    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "Check if there is an active build task with status BUILDING that has not passed quality gates. If found, warn the user: 'Build in progress without quality gate verification. Are you sure you want to stop?' and ask for confirmation before allowing stop."
          },
          {
            "type": "prompt",
            "prompt": "Check for active orchestration session in .studio/orchestration/.current. If found, save a checkpoint using scripts/orchestrator.sh checkpoint 'session_interrupted' before stopping. Report: 'Orchestration checkpoint saved. Resume with /orchestrate resume.'"
          }
        ]
      }
    ],

    "SubagentStart": [
      {
        "matcher": "planner|builder|architect",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "AGENT STARTUP PROTOCOL:\n\n1. CHECK if orchestration is active (.studio/orchestration/.current exists)\n\n2. IF orchestration active:\n   a) Run: scripts/orchestrator.sh agent-start [agent_name]\n   b) Check for incoming handoff: scripts/orchestrator.sh get-handoff [agent_name]\n      - If handoff exists, include the context_passed data in agent context\n      - This contains task_id, plan_path, learnings, and other workflow context\n\n3. DETECT relevant skills for this agent's work:\n   a) Get the current goal from orchestration state or user input\n   b) Run: scripts/skills.sh detect \"$GOAL\"\n   c) For each detected skill (sorted by score):\n      - Run: scripts/skills.sh inject <skill_name>\n      - Include the injection content (questions, guidelines, checklist) in agent context\n\n4. SKILL INJECTION FORMAT:\n   If skills detected, prepend to agent context:\n   ---\n   ## Active Skills: [skill1, skill2]\n   \n   [Injection content from each skill]\n   ---\n\nThis ensures agents receive domain-specific guidance before execution."
          }
        ]
      }
    ],

    "ContextPressure": [
      {
        "matcher": "warning|critical",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "Context pressure detected at {level} level. Run scripts/context-manager.sh scan to identify optimization opportunities. For learnings pool: consider summarizing entries older than 30 days. For plans pool: consider removing completed task plans. For context7 pool: clear cached docs for unused libraries."
          }
        ]
      }
    ]
  }
}
