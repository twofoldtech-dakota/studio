{
  "description": "STUDIO Intelligent Hook System - Self-correcting autonomous workflow with progress visualization, error classification, self-review, and interactive mode",
  "version": "2.3.0",

  "hooks": {
    "SessionStart": [
      {
        "matcher": "startup",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/hooks/session-start.sh",
            "timeout": 5000
          }
        ]
      },
      {
        "matcher": "compact",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/hooks/restore-context.sh"
          }
        ]
      }
    ],

    "PreCompact": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/hooks/save-context.sh"
          }
        ]
      }
    ],

    "UserPromptSubmit": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/hooks/inject-context.sh"
          }
        ]
      }
    ],

    "SubagentStart": [
      {
        "matcher": "builder",
        "hooks": [
          {
            "type": "agent",
            "prompt": "Pre-flight check before building. Verify: 1) A valid plan.json exists in the current task directory 2) The plan has status READY_TO_BUILD or challenge_results.overall_verdict is APPROVED 3) All dependencies mentioned in the plan are available. If ANY check fails, return {\"ok\": false, \"reason\": \"Cannot start build: [specific issue]\"}. If all checks pass, return {\"ok\": true}.",
            "timeout": 30
          }
        ]
      }
    ],

    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "You are a plan alignment checker. The builder should only make changes that align with the current plan. Check if this file operation aligns with the plan steps. Tool: $TOOL_NAME, File: $FILE_PATH. If this appears to be an unauthorized change or drift from the plan, return {\"ok\": false, \"reason\": \"This change doesn't align with the current plan step. Please follow the plan.\"}. If it aligns or there's no active plan, return {\"ok\": true}.",
            "model": "haiku"
          }
        ]
      },
      {
        "matcher": "Edit|Write",
        "condition": "env.STUDIO_INTERACTIVE == 'true'",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "INTERACTIVE MODE: About to execute $TOOL_NAME on $FILE_PATH.\n\nPreview the change and ask for user confirmation:\n\nOptions:\n[y] Execute this change\n[e] Edit the change first\n[s] Skip this step\n[a] Abort the build\n\nWait for user input. If user chooses:\n- 'y': return {\"ok\": true}\n- 'e': ask what to modify, apply changes, then return {\"ok\": true}\n- 's': return {\"ok\": false, \"reason\": \"User chose to skip this step\"}\n- 'a': return {\"ok\": false, \"reason\": \"User aborted the build\"}"
          }
        ]
      }
    ],

    "PostToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/hooks/track-progress.sh",
            "timeout": 5000
          },
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/hooks/emit-progress.sh",
            "timeout": 3000
          },
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/hooks/detect-corrections.sh",
            "timeout": 5000
          }
        ]
      }
    ],

    "PostToolUseFailure": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/hooks/classify-error.sh",
            "timeout": 5000
          },
          {
            "type": "agent",
            "prompt": "A tool call failed. The error has been classified above (if a pattern matched). Review the classification and: 1) If an auto-fix is available, ask the user if they want to apply it 2) If no auto-fix, provide the suggested manual fixes 3) Check if this is a recurring pattern worth remembering in studio/memory/failures.md. Return {\"ok\": true} after analysis.",
            "timeout": 30
          }
        ]
      }
    ],

    "SubagentStop": [
      {
        "matcher": "planner",
        "hooks": [
          {
            "type": "agent",
            "prompt": "Validate the planner's output and calculate confidence score.\n\n1. PLAN VALIDATION:\n   - Check plan.json was written with all sections\n   - Verify challenge_results.overall_verdict is APPROVED\n   - Confirm all steps have validation_commands\n\n2. CONFIDENCE SCORING:\n   Run: ${CLAUDE_PLUGIN_ROOT}/scripts/manifest.sh confidence\n   \n   If confidence < 70%, warn the user and ask if they want to:\n   - Improve the plan (add more requirements, edge cases)\n   - Proceed anyway\n   - Abort\n\n3. RESPONSE:\n   If plan invalid: {\"ok\": false, \"reason\": \"Plan incomplete: [issue]\"}\n   If confidence < 70%: {\"ok\": true, \"warning\": \"Low confidence ([X]%). Consider improving plan.\"}\n   If all good: {\"ok\": true, \"confidence\": [score]}",
            "timeout": 90
          }
        ]
      },
      {
        "matcher": "builder",
        "hooks": [
          {
            "type": "agent",
            "prompt": "Perform SELF-REVIEW of the build before completion.\n\n1. VALIDATION CHECK:\n   For each step in plan.json:\n   - Run validation_command from success_criteria\n   - Verify output matches expected_output\n   - Check manifest shows step completed\n\n2. SELF-REVIEW (compare against plan):\n   For each file created/modified:\n   - Does it match the specification in the plan?\n   - Does it follow embedded_context.memory_rules?\n   - Are there obvious security issues? (injection, XSS, exposed secrets)\n   - Does the code match discovered_patterns?\n\n3. REVIEW SUMMARY:\n   Generate a review like:\n   ```json\n   {\n     \"reviewed_files\": [\"file1.ts\", \"file2.ts\"],\n     \"requirements_met\": [\"REQ-001\", \"REQ-002\"],\n     \"requirements_missing\": [],\n     \"suggestions\": [\"Consider adding rate limiting\"],\n     \"security_concerns\": [],\n     \"verdict\": \"APPROVED|NEEDS_REVIEW|REJECTED\"\n   }\n   ```\n\n4. RESPONSE:\n   If validation fails: {\"ok\": false, \"reason\": \"Build incomplete: [details]\"}\n   If review finds issues: {\"ok\": true, \"review\": {...}, \"warning\": \"Review found [N] suggestions\"}\n   If all good: {\"ok\": true, \"review\": {...}}",
            "timeout": 180
          }
        ]
      }
    ],

    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/hooks/check-stop.sh",
            "timeout": 5000
          }
        ]
      }
    ]
  }
}
