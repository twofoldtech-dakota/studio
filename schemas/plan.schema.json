{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://studio.plugin/schemas/plan.schema.json",
  "title": "STUDIO Plan",
  "description": "Plan structure for STUDIO task execution with acceptance criteria and quality gates",
  "type": "object",
  "required": ["id", "task_id", "goal", "created_at", "gathered_requirements", "acceptance_criteria", "steps", "quality_gates"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^bp_[0-9]{8}_[0-9]{6}_[a-f0-9]{4}$",
      "description": "Unique plan identifier (format: bp_YYYYMMDD_HHMMSS_XXXX)"
    },
    "task_id": {
      "type": "string",
      "pattern": "^task_[0-9]{8}_[0-9]{6}$",
      "description": "Reference to the parent task"
    },
    "goal": {
      "type": "string",
      "description": "The goal this plan addresses"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of plan creation"
    },
    "context": {
      "type": "object",
      "description": "Context gathered during planning",
      "properties": {
        "learnings_loaded": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Domains from which learnings were loaded"
        },
        "patterns_discovered": {
          "type": "object",
          "description": "Patterns discovered in the codebase"
        },
        "dependencies": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Project dependencies relevant to this plan"
        },
        "context7_docs": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "library": {"type": "string"},
              "topic": {"type": "string"},
              "content": {"type": "string"}
            }
          },
          "description": "Documentation fetched from Context7 MCP"
        }
      }
    },
    "gathered_requirements": {
      "type": "object",
      "description": "Requirements gathered through iterative questioning",
      "required": ["scope", "user_confirmations"],
      "properties": {
        "scope": {
          "type": "object",
          "required": ["included", "excluded"],
          "properties": {
            "included": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Features explicitly included in scope"
            },
            "excluded": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Features explicitly excluded from scope"
            }
          }
        },
        "success_criteria": {
          "type": "array",
          "items": {"type": "string"},
          "description": "How the user will know when this is complete"
        },
        "technical_constraints": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Technical constraints identified"
        },
        "edge_cases": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "case": {"type": "string"},
              "handling": {"type": "string"}
            }
          },
          "description": "Edge cases identified through adversarial questioning"
        },
        "quality_requirements": {
          "type": "object",
          "properties": {
            "testing": {"type": "array", "items": {"type": "string"}},
            "security": {"type": "array", "items": {"type": "string"}},
            "performance": {"type": "array", "items": {"type": "string"}}
          }
        },
        "user_confirmations": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["question", "response"],
            "properties": {
              "question": {"type": "string"},
              "response": {"type": "string"},
              "round": {"type": "integer", "description": "Which questioning round"}
            }
          },
          "description": "Record of user confirmations during questioning"
        }
      }
    },
    "acceptance_criteria": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "criterion", "verification", "priority"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^AC-[0-9]+$",
            "description": "Acceptance criterion identifier"
          },
          "criterion": {
            "type": "string",
            "description": "What must be true for this to pass"
          },
          "verification": {
            "oneOf": [
              {
                "type": "object",
                "required": ["type", "command"],
                "properties": {
                  "type": {"const": "command"},
                  "command": {"type": "string", "description": "Shell command to run"}
                },
                "additionalProperties": false
              },
              {
                "type": "object",
                "required": ["type", "path"],
                "properties": {
                  "type": {"const": "file_exists"},
                  "path": {"type": "string", "description": "Path that must exist"}
                },
                "additionalProperties": false
              },
              {
                "type": "object",
                "required": ["type", "path", "pattern"],
                "properties": {
                  "type": {"const": "file_contains"},
                  "path": {"type": "string", "description": "File to check"},
                  "pattern": {"type": "string", "description": "Regex pattern to match"}
                },
                "additionalProperties": false
              },
              {
                "type": "object",
                "required": ["type", "test_command"],
                "properties": {
                  "type": {"const": "test_passes"},
                  "test_command": {"type": "string", "description": "Test command to run"}
                },
                "additionalProperties": false
              },
              {
                "type": "object",
                "required": ["type", "url", "assertions"],
                "properties": {
                  "type": {"const": "playwright"},
                  "url": {"type": "string", "description": "URL to navigate to"},
                  "actions": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["action"],
                      "properties": {
                        "action": {
                          "type": "string",
                          "enum": ["click", "fill", "check", "select", "hover", "wait"]
                        },
                        "selector": {"type": "string"},
                        "value": {"type": "string"},
                        "timeout": {"type": "integer"}
                      }
                    },
                    "description": "Actions to perform before assertions"
                  },
                  "assertions": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["type"],
                      "properties": {
                        "type": {
                          "type": "string",
                          "enum": ["visible", "hidden", "text_contains", "url_contains", "screenshot"]
                        },
                        "selector": {"type": "string"},
                        "value": {"type": "string"},
                        "timeout": {"type": "integer"}
                      }
                    },
                    "description": "Assertions to verify"
                  }
                },
                "additionalProperties": false
              }
            ],
            "description": "How to verify this criterion passes"
          },
          "priority": {
            "type": "string",
            "enum": ["must", "should", "nice-to-have"],
            "description": "Priority level (must=blocking, should=important, nice-to-have=optional)"
          }
        }
      },
      "description": "Acceptance criteria with verification methods"
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "name", "action", "success_criteria"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^step_[0-9]+[a-z]?$",
            "description": "Step identifier"
          },
          "name": {
            "type": "string",
            "description": "Short descriptive name"
          },
          "action": {
            "type": "string",
            "description": "What to do in this step"
          },
          "success_criteria": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "object",
              "required": ["criterion", "verification"],
              "properties": {
                "criterion": {"type": "string"},
                "verification": {
                  "type": "object",
                  "description": "Same structure as acceptance_criteria.verification"
                }
              }
            }
          },
          "depends_on": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Step IDs this depends on"
          },
          "retry_behavior": {
            "type": "object",
            "properties": {
              "max_attempts": {"type": "integer", "default": 5},
              "fix_hints": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          }
        }
      }
    },
    "quality_gates": {
      "type": "object",
      "description": "Commands to run after all acceptance criteria pass",
      "properties": {
        "lint": {
          "type": "string",
          "description": "Lint command (e.g., npm run lint)"
        },
        "typecheck": {
          "type": "string",
          "description": "Type check command (e.g., npx tsc --noEmit)"
        },
        "test": {
          "type": "string",
          "description": "Test command (e.g., npm test)"
        },
        "security": {
          "oneOf": [
            {"type": "string"},
            {
              "type": "object",
              "properties": {
                "npm_audit": {
                  "type": "string",
                  "default": "npm audit --audit-level=high"
                },
                "secrets_scan": {
                  "type": "string",
                  "default": "npx secretlint '**/*'"
                },
                "owasp_checks": {
                  "type": "array",
                  "items": {"type": "string"},
                  "description": "Additional OWASP security checks"
                }
              }
            }
          ],
          "description": "Security check commands"
        },
        "accessibility": {
          "type": "object",
          "description": "Accessibility quality gates (frontend tasks)",
          "properties": {
            "axe_core": {
              "type": "string",
              "default": "npx @axe-core/cli --exit"
            },
            "lighthouse_a11y": {
              "type": "object",
              "properties": {
                "command": {"type": "string"},
                "threshold": {"type": "integer", "default": 90}
              }
            }
          }
        },
        "performance": {
          "type": "object",
          "description": "Performance quality gates (frontend tasks)",
          "properties": {
            "lighthouse_perf": {
              "type": "object",
              "properties": {
                "command": {"type": "string"},
                "threshold": {"type": "integer", "default": 90}
              }
            },
            "core_web_vitals": {
              "type": "object",
              "properties": {
                "lcp_ms": {"type": "integer", "default": 2500, "description": "Largest Contentful Paint threshold"},
                "cls": {"type": "number", "default": 0.1, "description": "Cumulative Layout Shift threshold"},
                "inp_ms": {"type": "integer", "default": 200, "description": "Interaction to Next Paint threshold"}
              }
            }
          }
        },
        "type_safety": {
          "type": "object",
          "description": "TypeScript and runtime type safety gates",
          "properties": {
            "typescript_strict": {
              "type": "string",
              "default": "npx tsc --noEmit --strict"
            },
            "zod_validation": {
              "type": "object",
              "properties": {
                "required_for": {
                  "type": "array",
                  "items": {"type": "string"},
                  "default": ["api_inputs", "form_data", "external_data"]
                },
                "pattern": {
                  "type": "string",
                  "default": "safeParse"
                }
              }
            }
          }
        }
      }
    },
    "dod_template": {
      "type": "string",
      "enum": ["universal", "frontend", "backend", "api-endpoint"],
      "description": "Definition of Done template to apply"
    },
    "embedded_context": {
      "type": "object",
      "description": "Context preservation for enterprise decomposition",
      "properties": {
        "invariants": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "type", "content"],
            "properties": {
              "id": {"type": "string", "pattern": "^(AD|CON|PAT|CNV)-[0-9]{3}$"},
              "type": {"type": "string", "enum": ["architectural_decision", "constraint", "pattern", "convention"]},
              "content": {"type": "string"}
            }
          },
          "description": "Project invariants relevant to this task"
        },
        "tier": {
          "type": "integer",
          "minimum": 0,
          "maximum": 3,
          "description": "Context tier for this task (0=invariants, 1=active, 2=summarized, 3=indexed)"
        },
        "adjacent_tasks": {
          "type": "array",
          "items": {"type": "string"},
          "maxItems": 2,
          "description": "IDs of previous and next tasks for context"
        },
        "domains": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Domains detected for this task (frontend, backend, security, etc.)"
        }
      }
    },
    "sicvf_validation": {
      "type": "object",
      "description": "SICVF atomic task validation results",
      "properties": {
        "passes": {"type": "boolean"},
        "single_pass": {"type": "object"},
        "independent": {"type": "object"},
        "clear_boundaries": {"type": "object"},
        "verifiable": {"type": "object"},
        "fits_context": {"type": "object"},
        "validated_at": {"type": "string", "format": "date-time"}
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "estimated_complexity": {
          "type": "string",
          "enum": ["trivial", "simple", "moderate", "complex", "ambitious"]
        },
        "total_steps": {"type": "integer"},
        "must_criteria_count": {"type": "integer"},
        "should_criteria_count": {"type": "integer"}
      }
    }
  }
}
