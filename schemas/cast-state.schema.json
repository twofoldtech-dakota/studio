{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://studio.plugin/schemas/cast-state.schema.json",
  "title": "STUDIO Cast State",
  "description": "Current state of an STUDIO cast with cross-references to related documents",
  "type": "object",
  "required": ["cast_id", "goal", "status", "phase", "started_at", "updated_at"],
  "properties": {
    "cast_id": {
      "type": "string",
      "pattern": "^cast_[0-9]{8}_[0-9]{6}$",
      "description": "Unique identifier for the cast (format: cast_YYYYMMDD_HHMMSS)"
    },
    "goal": {
      "type": "string",
      "description": "Original goal text provided by the user"
    },
    "status": {
      "type": "string",
      "enum": ["INITIALIZING", "BLUEPRINTING", "FORGING", "TEMPERING", "COMPLETE", "FAILED", "ABORTED"],
      "description": "Current status of the cast"
    },
    "phase": {
      "type": "integer",
      "enum": [0, 1, 2, 3],
      "description": "Current phase number (0=init, 1=blueprinting, 2=forging, 3=tempering)"
    },
    "started_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the cast was started"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of last state update"
    },
    "completed_at": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "ISO 8601 timestamp when the cast completed (null if not complete)"
    },
    "blueprint_id": {
      "type": ["string", "null"],
      "pattern": "^bp_[0-9]{8}_[0-9]{6}_[a-f0-9]{4}$",
      "description": "Reference to the blueprint document (format: bp_YYYYMMDD_HHMMSS_XXXX)"
    },
    "forge_log_hash": {
      "type": ["string", "null"],
      "pattern": "^sha256:[a-f0-9]{64}$",
      "description": "SHA256 hash of the forge log for integrity verification"
    },
    "temper_report_id": {
      "type": ["string", "null"],
      "pattern": "^tr_[0-9]{8}_[0-9]{6}$",
      "description": "Reference to the temper report (format: tr_YYYYMMDD_HHMMSS)"
    },
    "current_step": {
      "type": ["string", "null"],
      "description": "ID of the currently executing step (null if not in forging)"
    },
    "completed_steps": {
      "type": "array",
      "items": { "type": "string" },
      "description": "List of completed step IDs"
    },
    "failed_steps": {
      "type": "array",
      "items": { "type": "string" },
      "description": "List of failed step IDs"
    },
    "skipped_steps": {
      "type": "array",
      "items": { "type": "string" },
      "description": "List of skipped step IDs"
    },
    "replan_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of replans executed during forging"
    },
    "temper_attempts": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of tempering attempts"
    },
    "last_verdict": {
      "type": ["string", "null"],
      "enum": ["STRONG", "SOUND", "BRITTLE", "CRACKED", null],
      "description": "Most recent temper verdict"
    },
    "checkpoints": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "reached_at", "status"],
        "properties": {
          "name": { "type": "string" },
          "after_step": { "type": "string" },
          "reached_at": { "type": "string", "format": "date-time" },
          "status": { "type": "string", "enum": ["passed", "failed"] }
        }
      },
      "description": "Checkpoints reached during execution"
    }
  }
}
