{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://studio.plugin/schemas/dod.schema.json",
  "title": "STUDIO Definition of Done",
  "description": "Definition of Done templates with executable verification criteria for enterprise quality gates",
  "type": "object",
  "required": ["version", "template_id", "name", "criteria"],

  "properties": {
    "version": {
      "type": "string",
      "const": "1.0.0"
    },
    "template_id": {
      "type": "string",
      "enum": ["universal", "frontend", "backend", "api-endpoint"],
      "description": "Template identifier"
    },
    "name": {
      "type": "string",
      "description": "Human-readable template name"
    },
    "description": {
      "type": "string",
      "description": "When to use this template"
    },
    "extends": {
      "type": "string",
      "enum": ["universal"],
      "description": "Parent template to inherit criteria from"
    },
    "criteria": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/criterion"
      },
      "minItems": 1
    },
    "metadata": {
      "type": "object",
      "properties": {
        "created_at": { "type": "string", "format": "date-time" },
        "updated_at": { "type": "string", "format": "date-time" },
        "applicable_pillars": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["data_schema", "auth", "api", "ui_ux", "integration", "infra_devops"]
          }
        }
      }
    }
  },

  "$defs": {
    "criterion": {
      "type": "object",
      "required": ["id", "criterion", "blocking"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^DoD-[A-Z]{1,3}-[0-9]+$",
          "description": "Criterion identifier (e.g., DoD-U-1, DoD-FE-2)"
        },
        "criterion": {
          "type": "string",
          "description": "What must be true for this criterion to pass"
        },
        "category": {
          "type": "string",
          "enum": ["lint", "typecheck", "test", "security", "accessibility", "performance", "validation", "documentation"],
          "description": "Category of this criterion"
        },
        "blocking": {
          "type": "boolean",
          "description": "If true, failing this criterion blocks completion"
        },
        "verification": {
          "oneOf": [
            { "$ref": "#/$defs/command_verification" },
            { "$ref": "#/$defs/pattern_verification" },
            { "$ref": "#/$defs/threshold_verification" },
            { "$ref": "#/$defs/file_verification" },
            { "$ref": "#/$defs/manual_verification" }
          ]
        },
        "fix_hints": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Suggestions for fixing failures"
        },
        "documentation_url": {
          "type": "string",
          "format": "uri",
          "description": "Link to relevant documentation"
        }
      }
    },

    "command_verification": {
      "type": "object",
      "required": ["type", "command"],
      "properties": {
        "type": { "const": "command" },
        "command": {
          "type": "string",
          "description": "Shell command to run"
        },
        "expected_exit_code": {
          "type": "integer",
          "default": 0
        },
        "timeout_ms": {
          "type": "integer",
          "default": 60000
        },
        "working_directory": {
          "type": "string",
          "description": "Directory to run command in (default: project root)"
        }
      }
    },

    "pattern_verification": {
      "type": "object",
      "required": ["type", "pattern"],
      "properties": {
        "type": { "const": "pattern" },
        "pattern": {
          "type": "string",
          "description": "Pattern that must be present (or absent)"
        },
        "must_exist": {
          "type": "boolean",
          "default": true,
          "description": "If true, pattern must be found; if false, pattern must NOT be found"
        },
        "file_glob": {
          "type": "string",
          "description": "Files to check (e.g., 'src/**/*.ts')"
        },
        "exclude_glob": {
          "type": "string",
          "description": "Files to exclude from check"
        }
      }
    },

    "threshold_verification": {
      "type": "object",
      "required": ["type", "metric", "operator", "threshold"],
      "properties": {
        "type": { "const": "threshold" },
        "metric": {
          "type": "string",
          "description": "Metric to check (e.g., 'lighthouse.accessibility', 'lcp_ms')"
        },
        "operator": {
          "type": "string",
          "enum": [">=", "<=", ">", "<", "=="]
        },
        "threshold": {
          "type": "number"
        },
        "extraction_command": {
          "type": "string",
          "description": "Command to extract the metric value"
        }
      }
    },

    "file_verification": {
      "type": "object",
      "required": ["type", "path"],
      "properties": {
        "type": { "const": "file" },
        "path": {
          "type": "string",
          "description": "File path or glob pattern"
        },
        "must_exist": {
          "type": "boolean",
          "default": true
        },
        "must_contain": {
          "type": "string",
          "description": "Pattern that must be in the file"
        },
        "must_not_contain": {
          "type": "string",
          "description": "Pattern that must NOT be in the file"
        }
      }
    },

    "manual_verification": {
      "type": "object",
      "required": ["type", "instructions"],
      "properties": {
        "type": { "const": "manual" },
        "instructions": {
          "type": "string",
          "description": "Instructions for manual verification"
        },
        "checklist": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    }
  }
}
