{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "task-manifest.schema.json",
  "title": "STUDIO Task Manifest",
  "description": "Unified tracking for requirements, tasks, and execution state",
  "type": "object",
  "required": ["id", "goal", "status", "requirements", "tasks", "timeline"],

  "properties": {
    "id": {
      "type": "string",
      "pattern": "^task_[0-9]{8}_[0-9]{6}$"
    },
    "goal": {
      "type": "string",
      "description": "The original user goal"
    },
    "status": {
      "type": "string",
      "enum": [
        "GATHERING",
        "PLANNING",
        "READY",
        "BUILDING",
        "VALIDATING",
        "BLOCKED",
        "COMPLETE",
        "FAILED",
        "ABORTED"
      ]
    },
    "created_at": { "type": "string", "format": "date-time" },
    "updated_at": { "type": "string", "format": "date-time" },
    "completed_at": { "type": "string", "format": "date-time" },

    "progress": {
      "type": "object",
      "description": "Real-time progress tracking",
      "properties": {
        "phase": {
          "type": "string",
          "enum": ["skill_acquisition", "context_lock", "requirements", "plan", "task", "validate"]
        },
        "phase_progress": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "overall_progress": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "current_task": { "type": "string" },
        "eta_seconds": { "type": "integer" }
      }
    },

    "requirements": {
      "type": "object",
      "description": "Requirements tracking with traceability",
      "properties": {
        "gathered_at": { "type": "string", "format": "date-time" },
        "confirmed_by_user": { "type": "boolean" },

        "functional": {
          "type": "array",
          "items": { "$ref": "#/$defs/requirement" }
        },
        "non_functional": {
          "type": "array",
          "items": { "$ref": "#/$defs/requirement" }
        },
        "constraints": {
          "type": "array",
          "items": { "$ref": "#/$defs/requirement" }
        },
        "out_of_scope": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },

    "tasks": {
      "type": "object",
      "description": "Task board with status tracking",
      "properties": {
        "backlog": {
          "type": "array",
          "items": { "$ref": "#/$defs/task" },
          "description": "Tasks not yet started"
        },
        "in_progress": {
          "type": "array",
          "items": { "$ref": "#/$defs/task" },
          "description": "Currently executing (max 1 for sequential)"
        },
        "blocked": {
          "type": "array",
          "items": { "$ref": "#/$defs/task" },
          "description": "Tasks waiting on resolution"
        },
        "completed": {
          "type": "array",
          "items": { "$ref": "#/$defs/task" },
          "description": "Successfully completed tasks"
        },
        "failed": {
          "type": "array",
          "items": { "$ref": "#/$defs/task" },
          "description": "Tasks that failed after max retries"
        }
      }
    },

    "artifacts": {
      "type": "object",
      "description": "All files created/modified",
      "properties": {
        "created": {
          "type": "array",
          "items": { "$ref": "#/$defs/artifact" }
        },
        "modified": {
          "type": "array",
          "items": { "$ref": "#/$defs/artifact" }
        },
        "deleted": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },

    "quality": {
      "type": "object",
      "description": "Quality metrics and validation results",
      "properties": {
        "checks_passed": { "type": "integer" },
        "checks_failed": { "type": "integer" },
        "checks_skipped": { "type": "integer" },
        "coverage_percent": { "type": "number" },
        "verdict": {
          "type": "string",
          "enum": ["PENDING", "STRONG", "SOUND", "UNSTABLE", "FAILED"]
        },
        "issues": {
          "type": "array",
          "items": { "$ref": "#/$defs/issue" }
        }
      }
    },

    "timeline": {
      "type": "array",
      "description": "Chronological event log",
      "items": { "$ref": "#/$defs/event" }
    },

    "metrics": {
      "type": "object",
      "description": "Performance and execution metrics",
      "properties": {
        "duration_ms": { "type": "integer" },
        "tasks_total": { "type": "integer" },
        "tasks_completed": { "type": "integer" },
        "tasks_failed": { "type": "integer" },
        "retries_total": { "type": "integer" },
        "tokens_used": { "type": "integer" }
      }
    }
  },

  "$defs": {
    "requirement": {
      "type": "object",
      "required": ["id", "description", "priority", "status"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^REQ-[0-9]{3}$",
          "description": "e.g., REQ-001"
        },
        "description": { "type": "string" },
        "priority": {
          "type": "string",
          "enum": ["must", "should", "could", "wont"]
        },
        "status": {
          "type": "string",
          "enum": ["gathered", "confirmed", "implemented", "verified", "deferred"]
        },
        "source": {
          "type": "string",
          "description": "Where this requirement came from (user, persona, discovered)"
        },
        "linked_tasks": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Task IDs that implement this requirement"
        },
        "acceptance_criteria": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },

    "task": {
      "type": "object",
      "required": ["id", "name", "status"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^TASK-[0-9]{3}$"
        },
        "name": { "type": "string" },
        "description": { "type": "string" },
        "status": {
          "type": "string",
          "enum": ["backlog", "ready", "in_progress", "blocked", "completed", "failed", "skipped"]
        },
        "linked_requirements": {
          "type": "array",
          "items": { "type": "string" },
          "description": "REQ IDs this task fulfills"
        },
        "depends_on": {
          "type": "array",
          "items": { "type": "string" }
        },
        "blocks": {
          "type": "array",
          "items": { "type": "string" }
        },
        "attempts": { "type": "integer", "default": 0 },
        "max_attempts": { "type": "integer", "default": 3 },
        "started_at": { "type": "string", "format": "date-time" },
        "completed_at": { "type": "string", "format": "date-time" },
        "duration_ms": { "type": "integer" },
        "artifacts_produced": {
          "type": "array",
          "items": { "type": "string" }
        },
        "validation_results": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "criterion": { "type": "string" },
              "passed": { "type": "boolean" },
              "output": { "type": "string" }
            }
          }
        },
        "blocker_reason": { "type": "string" },
        "failure_reason": { "type": "string" }
      }
    },

    "artifact": {
      "type": "object",
      "required": ["path", "task_id"],
      "properties": {
        "path": { "type": "string" },
        "task_id": { "type": "string" },
        "created_at": { "type": "string", "format": "date-time" },
        "size_bytes": { "type": "integer" },
        "checksum": { "type": "string" }
      }
    },

    "issue": {
      "type": "object",
      "required": ["severity", "description"],
      "properties": {
        "id": { "type": "string" },
        "severity": {
          "type": "string",
          "enum": ["critical", "important", "minor"]
        },
        "description": { "type": "string" },
        "task_id": { "type": "string" },
        "requirement_id": { "type": "string" },
        "suggested_fix": { "type": "string" },
        "resolved": { "type": "boolean", "default": false }
      }
    },

    "event": {
      "type": "object",
      "required": ["timestamp", "type", "message"],
      "properties": {
        "timestamp": { "type": "string", "format": "date-time" },
        "type": {
          "type": "string",
          "enum": [
            "task_started",
            "phase_started",
            "phase_completed",
            "skill_loaded",
            "persona_loaded",
            "requirement_gathered",
            "requirement_confirmed",
            "task_started",
            "task_completed",
            "task_failed",
            "task_retried",
            "task_blocked",
            "artifact_created",
            "validation_passed",
            "validation_failed",
            "quality_gate_started",
            "quality_gate_passed",
            "quality_gate_failed",
            "task_completed",
            "task_failed",
            "user_input",
            "error"
          ]
        },
        "message": { "type": "string" },
        "details": { "type": "object" }
      }
    }
  }
}
